{% extends "base.html" %}

{% block content %}
{% call components.glass_container() %}
    <img src="/static/logo.png" alt="Node Logo" class="logo">
    <h1 class="title">node</h1>

    {% call components.glass_form() %}
    <form action="/note/{{ uuid }}" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <select name="content_type" id="content_type" onchange="showContentInput()" class="btn">
                <option value="url">URL Link</option>
                <option value="text">Text Note</option>
                <option value="image">Image Upload</option>
            </select>
        </div>

        <div id="url-input" class="form-group">
            <input type="url" id="url-content" name="url_content" placeholder="Enter URL" class="modern-input">
        </div>

        <div id="text-input" class="form-group" style="display: none;">
            <textarea id="text-content" name="text_content" rows="4" placeholder="Type your note here..." class="modern-input"></textarea>
        </div>

        <div id="image-input" class="form-group" style="display: none;">
            <label for="image" class="file-upload-btn">
                Choose Image
                <input type="file" id="image" name="image" accept="image/*" style="display: none;">
            </label>
            <div id="file-name" class="file-name"></div>
        </div>

    <input type="hidden" id="content" name="content" value="">
    <button type="submit" class="btn" disabled>Attach Content</button>
</form>

<script>
// Show file name when a file is selected
document.getElementById('image').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || 'No file selected';
    document.getElementById('file-name').textContent = fileName;
    validateContent();
});

function isValidUrl(string) {
    try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
        return false;
    }
}

function validateContent() {
    const contentType = document.getElementById('content_type').value;
    const submitButton = document.querySelector('button[type="submit"]');
    
    let isValid = false;
    let helperText = 'Add content first';
    
    if (contentType === 'url') {
        const urlValue = document.getElementById('url-content').value.trim();
        isValid = urlValue !== '' && isValidUrl(urlValue);
        if (!isValid && urlValue !== '') {
            helperText = 'Please enter a complete URL\n(e.g., https://youtu.be/...)';
        }
    } else if (contentType === 'text') {
        isValid = document.getElementById('text-content').value.trim() !== '';
        if (!isValid) {
            helperText = 'Add some text first';
        }
    } else if (contentType === 'image') {
        isValid = document.getElementById('image').files.length > 0;
        if (!isValid) {
            helperText = 'Choose an image first';
        }
    }
    
    submitButton.disabled = !isValid;
    submitButton.setAttribute('data-helper-text', helperText);
    return isValid;
}

function showContentInput() {
    const contentType = document.getElementById('content_type').value;
    const contentField = document.getElementById('content');
    
    // Hide all input types with fade effect
    document.getElementById('url-input').style.display = 'none';
    document.getElementById('text-input').style.display = 'none';
    document.getElementById('image-input').style.display = 'none';
    
    // Remove existing event listeners
    const urlContent = document.getElementById('url-content');
    const textContent = document.getElementById('text-content');
    const newUrlContent = urlContent.cloneNode(true);
    const newTextContent = textContent.cloneNode(true);
    urlContent.parentNode.replaceChild(newUrlContent, urlContent);
    textContent.parentNode.replaceChild(newTextContent, textContent);
    
    // Show selected input type with fade effect
    if (contentType === 'url') {
        document.getElementById('url-input').style.display = 'block';
        newUrlContent.addEventListener('input', function(e) {
            contentField.value = e.target.value;
            validateContent();
        });
    } else if (contentType === 'text') {
        document.getElementById('text-input').style.display = 'block';
        newTextContent.addEventListener('input', function(e) {
            contentField.value = e.target.value;
            validateContent();
        });
    } else if (contentType === 'image') {
        document.getElementById('image-input').style.display = 'block';
        contentField.value = '';
    }
    validateContent();
}

document.addEventListener('DOMContentLoaded', function() {
    // Set up initial content value for URL (since it's the default selected type)
    const urlInput = document.getElementById('url-content');
    const contentField = document.getElementById('content');
    urlInput.addEventListener('input', function(e) {
        contentField.value = e.target.value;
    });
    
    // Handle form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const contentType = document.getElementById('content_type').value;
        const contentField = document.getElementById('content');
        
        if (contentType === 'url') {
            contentField.value = document.getElementById('url-content').value;
        } else if (contentType === 'text') {
            contentField.value = document.getElementById('text-content').value;
        }
        // For image type, we don't need to set content as it's handled by the server
    });
});
</script>
    {% endcall %}
{% endcall %}
{% endblock %}